{% load static %}
<div class="content-wrapper">
  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1>Tasdiqlash</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="#">Home</a></li>
            <li class="breadcrumb-item active">Tasdiqlash</li>
          </ol>
        </div>
      </div>
    </div>
  </section>

  <section class="content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">

          <!-- Guruh tanlash qismi -->
          <form method="get" action="">
            <div class="form-group mb-3">
              <label for="group-select">Guruhni tanlang:</label>
              <select id="group-select" name="group_id" class="form-control" onchange="this.form.submit()">
                <option value="">-- Tanlang --</option>
                {% for g in groups %}
                  <option value="{{ g.id }}" {% if selected_group and selected_group.id == g.id %}selected{% endif %}>
                    {{ g.group_name }}
                  </option>
                {% endfor %}
              </select>
            </div>
          </form>

          <!-- Umumiy Export tugmalari -->
          <div id="export-buttons" class="mb-3 text-right">
            <span class="mr-2 font-weight-bold">Kabi saqlash:</span>
            <button id="export-excel" class="btn btn-success btn-sm">Excel</button>
            <button id="export-pdf" class="btn btn-danger btn-sm">PDF</button>
            <button id="export-csv" class="btn btn-primary btn-sm">CSV</button>
          </div>

          <!-- Jadval 1 -->
          <div class="card">
            <div class="card-header"><h3 class="card-title font-weight-bold">Tasdiqlangan Talabalar</h3></div>
            <div class="card-body">
              <div style="max-height:400px;overflow-y:auto;">
                <table id="example1" class="table table-bordered table-striped table-hover">
                  <thead>
                  <tr>
                    <th>№</th>
                    <th>Telegram id</th>
                    <th>Username</th>
                    <th>F.I.O</th>
                    <th>Group ID</th>
                    <th>PINFL</th>
                    <th>Tg Tel:</th>
                    <th>Tel:</th>
                    <th>Parent Tel:</th>
                    <th>Manzil</th>
                  </tr>
                  </thead>
                  <tbody>
                    {% for reg_t in reg_true %}
                    <tr>
                      <th>{{ forloop.counter }}</th>
                      <td>{{ reg_t.telegram_id }}</td>
                      <td>{{ reg_t.username }}</td>
                      <td>{{ reg_t.fio }}</td>
                      <td>{{ reg_t.register_group }}</td>
                      <td>{{ reg_t.pnfl }}</td>
                      <td>{{ reg_t.tg_tel }}</td>
                      <td>{{ reg_t.tel }}</td>
                      <td>{{ reg_t.parent_tel }}</td>
                      <td>{{ reg_t.address }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Jadval 2 -->
          <div class="card mt-4">
            <div class="card-header"><h3 class="card-title font-weight-bold">O'qituvchilar</h3></div>
            <div class="card-body">
              <div style="max-height:400px;overflow-y:auto;">
                <table id="example2" class="table table-bordered table-striped table-hover">
                  <thead>
                  <tr>
                    <th>№</th>
                    <th>Telegram id</th>
                    <th>Username</th>
                    <th>F.I.O</th>
                    <th>Group ID</th>
                    <th>PINFL</th>
                    <th>Tg Tel:</th>
                    <th>Tel:</th>
                    <th>Parent Tel:</th>
                    <th>Manzil</th>
                  </tr>
                  </thead>
                  <tbody>
                    {% for teach in teacher %}
                    <tr>
                      <th>{{ forloop.counter }}</th>
                      <td>{{ teach.telegram_id }}</td>
                      <td>{{ teach.username }}</td>
                      <td>{{ teach.fio }}</td>
                      <td>{{ teach.register_group }}</td>
                      <td>{{ teach.pnfl }}</td>
                      <td>{{ teach.tg_tel }}</td>
                      <td>{{ teach.tel }}</td>
                      <td>{{ teach.parent_tel }}</td>
                      <td>{{ teach.address }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Jadval 3 -->
          <div class="card mt-4">
            <div class="card-header"><h3 class="card-title font-weight-bold">Tasdiqlanmagan Talabalar</h3></div>
            <div class="card-body">
              <div style="max-height:400px;overflow-y:auto;">
                <form method="post" action="{% url 'bulk_update_register' %}">
                  {% csrf_token %}
                  <input type="hidden" name="group_id" value="{{ selected_group.id }}">
                  <table id="example3" class="table table-bordered table-striped table-hover">
                    <thead>
                    <tr>
                      <th>№</th>
                      <th>Telegram id</th>
                      <th>Username</th>
                      <th>F.I.O</th>
                      <th>Group ID</th>
                      <th>PINFL</th>
                      <th>Tg Tel:</th>
                      <th>Tel:</th>
                      <th>Parent Tel:</th>
                      <th>Manzil</th>
                      <th>Talaba</th>
                      <th>O'qituvchi</th>
                    </tr>
                    </thead>
                    <tbody>
                      {% for reg_f in reg_false %}
                      <tr>
                        <th>{{ forloop.counter }}</th>
                        <td>{{ reg_f.telegram_id }}</td>
                        <td>{{ reg_f.username }}</td>
                        <td>{{ reg_f.fio }}</td>
                        <td>{{ reg_f.register_group }}</td>
                        <td>{{ reg_f.pnfl }}</td>
                        <td>{{ reg_f.tg_tel }}</td>
                        <td>{{ reg_f.tel }}</td>
                        <td>{{ reg_f.parent_tel }}</td>
                        <td>{{ reg_f.address }}</td>
                        <td style="text-align:center;">
                          <div class="form-check">
                            <input class="form-check-input student-checkbox" 
                                  type="checkbox" 
                                  name="active_students" 
                                  value="{{ reg_f.id }}" 
                                  id="student_{{ reg_f.id }}">
                          </div>
                        </td>
                        <td style="text-align:center;">
                          <div class="form-check">
                            <input class="form-check-input teacher-checkbox" 
                                  type="checkbox" 
                                  name="teachers" 
                                  value="{{ reg_f.id }}" 
                                  id="teacher_{{ reg_f.id }}">
                          </div>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                  <div class="mt-3 text-right">
                    <button type="submit" class="btn btn-success">Saqlash</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Xabar yuborish uchun forma -->
          {% if selected_group %}
          <div class="card mt-4">
            <div class="card-header">
              <h3 class="card-title font-weight-bold">Xabar yuborish</h3>
            </div>
            <div class="card-body">
              <form id="messageForm">
                {% csrf_token %}
                <input type="hidden" name="group_id" value="{{ selected_group.id }}">
                
                <div class="row">
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="target-select">Kimga yuborish:</label>
                      <select id="target-select" name="target" class="form-control" required>
                        <option value="">-- Tanlang --</option>
                        <option value="reg_true">Tasdiqlangan Talabalar ({{ reg_true|length }})</option>
                        <option value="teacher">O'qituvchilar ({{ teacher|length }})</option>
                        <option value="reg_false">Tasdiqlanmagan Talabalar ({{ reg_false|length }})</option>
                      </select>
                    </div>
                  </div>
                  
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="method-select">Yuborish usuli:</label>
                      <select id="method-select" name="method" class="form-control" required>
                        <option value="">-- Tanlang --</option>
                        <option value="private">Private Chat (shaxsiy xabar)</option>
                        <option value="group">Guruh Chatiga yuborish</option>
                      </select>
                    </div>
                  </div>
                  
                  <div class="col-md-4">
                    <div class="form-group">
                      <label>&nbsp;</label>
                      <div>
                        <button type="submit" class="btn btn-primary btn-block">
                          <i class="fas fa-paper-plane"></i> Xabar yuborish
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="form-group">
                  <label for="message-input">Xabar matni:</label>
                  <textarea id="message-input" name="message" class="form-control" rows="4" 
                           placeholder="Bu yerga xabar matnini kiriting..." required></textarea>
                  <small class="form-text text-muted">
                    <strong>Private Chat:</strong> har bir foydalanuvchiga alohida shaxsiy xabar yuboriladi<br>
                    <strong>Guruh Chat:</strong> faqat guruh chatiga bitta xabar yuboriladi
                  </small>
                </div>
              </form>

              <!-- Natija ko'rsatish qismi -->
              <div id="messageResult" style="display: none;" class="mt-3">
                <div class="alert alert-info" style="background-color: rgb(161, 191, 211);">
                  <strong>Natija:</strong>
                  <div id="resultContent"></div>
                </div>
              </div>

              <!-- Loading spinner -->
              <div id="loadingSpinner" style="display: none;" class="text-center mt-3">
                <div class="spinner-border" role="status">
                  <span class="sr-only">Yuklanmoqda...</span>
                </div>
                <p>Xabarlar yuborilmoqda...</p>
              </div>
            </div>
          </div>
          {% endif %}

        </div>
      </div>
    </div>
  </section>


</div>