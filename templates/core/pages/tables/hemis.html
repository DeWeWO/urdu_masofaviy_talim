{% extends  'base.html' %}
{% load static %}

{% block title %} Hemis Table {% endblock title %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'plugins/datatables-bs4/css/dataTables.bootstrap4.min.css' %}">
  <link rel="stylesheet" href="{% static 'plugins/datatables-responsive/css/responsive.bootstrap4.min.css' %}">
  <link rel="stylesheet" href="{% static 'plugins/datatables-buttons/css/buttons.bootstrap4.min.css' %}">
  <link rel="stylesheet" href="{% static 'dist/css/adminlte.min.css' %}">

  <style>
  .badge {
    font-size: 0.75em;
    margin: 1px;
  }

  .table td {
    vertical-align: middle;
  }

  .text-success { color: #28a745 !important; }
  .text-warning { color: #ffc107 !important; }
  .text-danger { color: #dc3545 !important; }
  .text-info { color: #17a2b8 !important; }
  .text-muted { color: #6c757d !important; }

  .badge-success { background-color: #28a745; }
  .badge-warning { background-color: #ffc107; color: #212529; }
  .badge-danger { background-color: #dc3545; }
  .badge-info { background-color: #17a2b8; }
  .badge-secondary { background-color: #6c757d; }

  small {
    font-size: 0.8em;
  }

  .select-wrapper{ position:relative; }
  .select-wrapper select{ padding-right:2.2rem; }
  .select-wrapper .clear-btn{
    position:absolute; right:.5rem; top:50%; transform:translateY(-50%);
    border:0; background:#f4f6f9; width:28px; height:28px; line-height:26px;
    text-align:center; border-radius:50%; cursor:pointer; font-size:18px;
    color:#dc3545; display:none;
  }
  .select-wrapper .clear-btn.show{ display:inline-block; }

  .dt-buttons {
    margin-right: 15px;
  }
  </style>
  
{% endblock %}


{% block content %}

  {% include 'base/navbar.html' %}

  {% include 'base/aside.html' with table_active=True hemis_active=True %}

  {% include 'base/content_hemistable.html' %}

  {% include 'base/footer.html' %}

  {% include 'base/down_aside.html' %}

{% endblock content %}


{% block extra_js %}
  <script src="{% static 'plugins/datatables/jquery.dataTables.min.js' %}"></script>
  <script src="{% static 'plugins/datatables-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
  <script src="{% static 'plugins/datatables-responsive/js/dataTables.responsive.min.js' %}"></script>
  <script src="{% static 'plugins/datatables-responsive/js/responsive.bootstrap4.min.js' %}"></script>
  <script src="{% static 'plugins/datatables-buttons/js/dataTables.buttons.min.js' %}"></script>
  <script src="{% static 'plugins/datatables-buttons/js/buttons.bootstrap4.min.js' %}"></script>
  <script src="{% static 'plugins/jszip/jszip.min.js' %}"></script>
  <script src="{% static 'plugins/pdfmake/pdfmake.min.js' %}"></script>
  <script src="{% static 'plugins/pdfmake/vfs_fonts.js' %}"></script>
  <script src="{% static 'plugins/datatables-buttons/js/buttons.html5.min.js' %}"></script>
  <script src="{% static 'plugins/datatables-buttons/js/buttons.print.min.js' %}"></script>
  <script src="{% static 'plugins/datatables-buttons/js/buttons.colVis.min.js' %}"></script>

  <script src="{% static 'dist/js/demo.js' %}"></script>

  <script>
    $(document).ready(function() {
      let table = $('#example1').DataTable({
        "responsive": true,
        "lengthChange": true,
        "autoWidth": false,
        "pageLength": 25,
        "order": [[0, "desc"]],
        "language": {
          "search": "Qidirish:",
          "lengthMenu": "_MENU_ ta yozuv ko'rsatish",
          "info": "_START_ dan _END_ gacha (_TOTAL_ dan)",
          "infoEmpty": "Ma'lumot yo'q",
          "paginate": {
            "first": "Birinchi",
            "last": "Oxirgi",
            "next": "Keyingi",
            "previous": "Oldingi"
          }
        },
        dom: '<"row"<"col-md-6"l><"col-md-6 d-flex justify-content-end align-items-center"Bf>>rtip',
        buttons: [
          { extend: 'colvis', text: "Ko'rsatiladigan ustunlar", className: 'btn btn-info'}
        ]
      });

      $('.custom-file-input').on('change', function() {
        let fileName = $(this).val().split('\\').pop();
        if (fileName) {
          $(this).siblings('.custom-file-label').addClass("selected").html(fileName);
        } else {
          $(this).siblings('.custom-file-label').removeClass("selected").html("Excel fayl tanlang...");
        }
      });
    });
  </script>

  <script>
  (function(){
    const table = document.getElementById('example1');
    if(!table) return;

    // Jadval sarlavhasidan ustun indekslarini topamiz
    function getColIndex(headerText){
      const ths = Array.from(table.querySelectorAll('thead th'));
      return ths.findIndex(th => th.textContent.trim().toLowerCase() === headerText.toLowerCase());
    }
    const courseCol = getColIndex('Kurs');
    const groupCol  = getColIndex('Guruh');
    if (courseCol === -1 || groupCol === -1) return;

    const rows = Array.from(table.querySelectorAll('tbody tr'))
                      .filter(tr => tr.querySelectorAll('td').length);

    // Unikal qiymatlarni yig'amiz
    function uniq(values){
      return Array.from(new Set(values.filter(v => v && v !== '-')));
    }

    const courses = uniq(rows.map(tr => tr.children[courseCol].textContent.trim()));
    const groups  = uniq(rows.map(tr => tr.children[groupCol].textContent.trim()));

    // Kurslarni tabiiy tartibda saralash (raqam bo'lsa raqam, bo'lmasa matn)
    courses.sort((a,b)=>{
      const na = parseInt(a,10), nb = parseInt(b,10);
      if(!isNaN(na) && !isNaN(nb)) return na-nb;
      return a.localeCompare(b, 'uz');
    });
    groups.sort((a,b)=> a.localeCompare(b, 'uz'));

    // Selectlarga option qo'shamiz
    const courseSelect = document.getElementById('courseFilter');
    const groupSelect  = document.getElementById('groupFilter');

    function fillOptions(select, arr, labelBuilder=(x)=>x){
      arr.forEach(v=>{
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = labelBuilder(v);
        select.appendChild(opt);
      });
    }
    fillOptions(courseSelect, courses, v => /\d+/.test(v) ? `${v}-kurs` : v);
    fillOptions(groupSelect, groups);

    // Clear tugmasi holati
    function syncClearBtn(select){
      const btn = select.parentElement.querySelector('.clear-btn');
      if(!btn) return;
      if(select.value) btn.classList.add('show'); else btn.classList.remove('show');
    }
    syncClearBtn(courseSelect);
    syncClearBtn(groupSelect);

    // Filterlash
    function applyFilter(){
      const cVal = courseSelect.value.trim();
      const gVal = groupSelect.value.trim();

      rows.forEach(tr=>{
        const cText = tr.children[courseCol].textContent.trim();
        const gText = tr.children[groupCol].textContent.trim();

        const okCourse = !cVal || cText === cVal;
        const okGroup  = !gVal || gText === gVal;

        tr.style.display = (okCourse && okGroup) ? '' : 'none';
      });

      syncClearBtn(courseSelect);
      syncClearBtn(groupSelect);
    }

    // Eventlar
    courseSelect.addEventListener('change', applyFilter);
    groupSelect.addEventListener('change', applyFilter);

    document.querySelectorAll('.clear-btn').forEach(btn=>{
      btn.addEventListener('click', function(){
        const targetSel = document.querySelector(this.getAttribute('data-target'));
        if(!targetSel) return;
        targetSel.value = '';
        applyFilter();
      });
    });

    // Agar URL'da ?course= yoki ?group= bo'lsa, avtomatik qo'llash (ixtiyoriy)
    const params = new URLSearchParams(window.location.search);
    if (params.get('course')) courseSelect.value = params.get('course');
    if (params.get('group'))  groupSelect.value  = params.get('group');
    applyFilter();
  })();
  </script>

{% endblock %}