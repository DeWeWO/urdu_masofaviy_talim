{% extends  'base.html' %}
{% load static %}

{% block title %} Telegram Guruhlar {% endblock title %}

{% block extra_css %}

  <link rel="stylesheet" href="{% static 'plugins/datatables-bs4/css/dataTables.bootstrap4.min.css' %}">
  <link rel="stylesheet" href="{% static 'plugins/datatables-responsive/css/responsive.bootstrap4.min.css' %}">
  <link rel="stylesheet" href="{% static 'plugins/datatables-buttons/css/buttons.bootstrap4.min.css' %}">
  
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }
      
      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: #f5f5f5;
          padding: 20px;
      }
      
      .container {
          max-width: 1200px;
          margin: 0 auto;
          background: white;
          border-radius: 10px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          overflow: hidden;
      }
      
      .header {
          background: #0088cc;
          color: white;
          padding: 20px;
          text-align: center;
      }
      
      .content {
          display: flex;
          min-height: 600px;
      }
      
      .message-panel {
          flex: 2;
          padding: 20px;
          border-right: 1px solid #eee;
      }
      
      .groups-panel {
          flex: 1;
          padding: 20px;
          background: #fafafa;
      }
      
      .form-group {
          margin-bottom: 20px;
      }
      
      label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #333;
      }
      
      textarea {
          width: 100%;
          min-height: 200px;
          padding: 15px;
          border: 2px solid #ddd;
          border-radius: 8px;
          font-size: 14px;
          font-family: inherit;
          resize: vertical;
      }
      
      textarea:focus {
          outline: none;
          border-color: #0088cc;
      }
      
      .file-upload-section {
          border: 2px dashed #ddd;
          border-radius: 8px;
          padding: 20px;
          text-align: center;
          background: #fafafa;
          margin-bottom: 15px;
      }
      
      .file-upload-section.dragover {
          border-color: #0088cc;
          background: #f0f8ff;
      }
      
      .file-input-wrapper {
          position: relative;
          display: inline-block;
      }
      
      .file-input {
          position: absolute;
          opacity: 0;
          width: 100%;
          height: 100%;
          cursor: pointer;
      }
      
      .file-button {
          background: #0088cc;
          color: white;
          padding: 12px 24px;
          border-radius: 6px;
          cursor: pointer;
          transition: background 0.3s;
          font-weight: 500;
      }
      
      .file-button:hover {
          background: #0077b5;
      }
      
      .file-info {
          margin-top: 10px;
          font-size: 12px;
          color: #666;
      }
      
      .selected-files {
          margin-top: 15px;
      }
      
      .file-item {
          display: flex;
          align-items: center;
          background: white;
          border: 1px solid #ddd;
          border-radius: 6px;
          padding: 10px;
          margin-bottom: 8px;
      }
      
      .file-icon {
          width: 40px;
          height: 40px;
          border-radius: 4px;
          margin-right: 12px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 16px;
          font-weight: bold;
          color: white;
      }
      
      .file-icon.image { background: #4CAF50; }
      .file-icon.video { background: #FF9800; }
      .file-icon.audio { background: #9C27B0; }
      .file-icon.document { background: #607D8B; }
      
      .file-details {
          flex: 1;
      }
      
      .file-name {
          font-weight: 500;
          color: #333;
          margin-bottom: 2px;
      }
      
      .file-size {
          font-size: 12px;
          color: #666;
      }
      
      .remove-file {
          width: 24px;
          height: 24px;
          border: none;
          background: #dc3545;
          color: white;
          border-radius: 50%;
          cursor: pointer;
          font-size: 14px;
          display: flex;
          align-items: center;
          justify-content: center;
      }
      
      .remove-file:hover {
          background: #c82333;
      }
      
      .groups-list {
          max-height: 450px;
          overflow-y: auto;
          border: 1px solid #ddd;
          border-radius: 8px;
          background: white;
      }
      
      .group-item {
          display: flex;
          align-items: center;
          padding: 12px;
          border-bottom: 1px solid #eee;
          transition: background 0.2s;
      }
      
      .group-item:hover {
          background: #f8f9fa;
      }
      
      .group-item:last-child {
          border-bottom: none;
      }
      
      .group-checkbox {
          margin-right: 10px;
          transform: scale(1.2);
      }
      
      .group-info {
          flex: 1;
      }
      
      .group-name {
          font-weight: 600;
          color: #333;
          margin-bottom: 2px;
      }
      
      .group-id {
          font-size: 12px;
          color: #666;
      }
      
      .select-all {
          padding: 10px;
          background: #e9ecef;
          border-bottom: 2px solid #ddd;
          font-weight: 600;
      }
      
      .send-button {
          background: #28a745;
          color: white;
          border: none;
          padding: 15px 30px;
          font-size: 16px;
          font-weight: 600;
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.3s;
          width: 100%;
      }
      
      .send-button:hover:not(:disabled) {
          background: #218838;
          transform: translateY(-1px);
      }
      
      .send-button:disabled {
          background: #6c757d;
          cursor: not-allowed;
      }
      
      .status {
          margin-top: 15px;
          padding: 12px;
          border-radius: 6px;
          display: none;
      }
      
      .status.success {
          background: #d4edda;
          border: 1px solid #c3e6cb;
          color: #155724;
      }
      
      .status.error {
          background: #f8d7da;
          border: 1px solid #f5c6cb;
          color: #721c24;
      }
      
      .loading {
          display: none;
          text-align: center;
          color: #666;
          margin-top: 10px;
      }
      
      .text-formatting-help {
          font-size: 12px;
          color: #666;
          margin-top: 5px;
          line-height: 1.4;
      }
      
      .progress-bar {
          width: 100%;
          height: 4px;
          background: #e9ecef;
          border-radius: 2px;
          overflow: hidden;
          margin-top: 10px;
          display: none;
      }
      
      .progress-fill {
          height: 100%;
          background: #0088cc;
          width: 0%;
          transition: width 0.3s;
      }
  </style>

{% endblock %}


{% block content %}

  {% include 'base/navbar.html' %}

  {% include 'base/aside.html' with table_active=True tg_active=True %}

  {% include 'base/content_tggroup.html' %}

  {% include 'base/footer.html' %}

  {% include 'base/down_aside.html' %}

{% endblock content %}
  

{% block extra_js %}

  <script src="{% static 'plugins/datatables/jquery.dataTables.min.js' %}"></script>
  <script src="{% static 'plugins/datatables-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
  <script src="{% static 'plugins/datatables-responsive/js/dataTables.responsive.min.js' %}"></script>
  <script src="{% static 'plugins/datatables-responsive/js/responsive.bootstrap4.min.js' %}"></script>
  <script src="{% static 'plugins/datatables-buttons/js/dataTables.buttons.min.js' %}"></script>
  <script src="{% static 'plugins/datatables-buttons/js/buttons.bootstrap4.min.js' %}"></script>
  <script src="{% static 'plugins/jszip/jszip.min.js' %}"></script>
  <script src="{% static 'plugins/pdfmake/pdfmake.min.js' %}"></script>
  <script src="{% static 'plugins/pdfmake/vfs_fonts.js' %}"></script>
  <script src="{% static 'plugins/datatables-buttons/js/buttons.html5.min.js' %}"></script>
  <script src="{% static 'plugins/datatables-buttons/js/buttons.print.min.js' %}"></script>
  <script src="{% static 'plugins/datatables-buttons/js/buttons.colVis.min.js' %}"></script>
  <script src="{% static 'dist/js/demo.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.min.js" integrity="sha384-RuyvpeZCxMJCqVUGFI0Do1mQrods/hhxYlcVfGPOfQtPJh0JCw12tUAZ/Mv10S7D" crossorigin="anonymous"></script>
    
  <script>
      let selectedFiles = [];
      
      // Select all functionality
      document.getElementById('selectAll').addEventListener('change', function() {
          const checkboxes = document.querySelectorAll('input[name="group_ids"]');
          checkboxes.forEach(checkbox => {
              checkbox.checked = this.checked;
          });
      });
      
      // File input change event
      document.getElementById('fileInput').addEventListener('change', function(e) {
          Array.from(e.target.files).forEach(file => {
              if (!selectedFiles.find(f => f.name === file.name && f.size === file.size)) {
                  selectedFiles.push(file);
              }
          });
          updateFilesList();
          e.target.value = ''; // Reset input
      });
      
      // Drag and drop
      const uploadSection = document.getElementById('fileUploadSection');
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          uploadSection.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
      }
      
      ['dragenter', 'dragover'].forEach(eventName => {
          uploadSection.addEventListener(eventName, highlight, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
          uploadSection.addEventListener(eventName, unhighlight, false);
      });
      
      function highlight() {
          uploadSection.classList.add('dragover');
      }
      
      function unhighlight() {
          uploadSection.classList.remove('dragover');
      }
      
      uploadSection.addEventListener('drop', handleDrop, false);
      
      function handleDrop(e) {
          const dt = e.dataTransfer;
          const files = dt.files;
          
          Array.from(files).forEach(file => {
              if (!selectedFiles.find(f => f.name === file.name && f.size === file.size)) {
                  selectedFiles.push(file);
              }
          });
          updateFilesList();
      }
      
      function updateFilesList() {
          const container = document.getElementById('selectedFiles');
          container.innerHTML = '';
          
          selectedFiles.forEach((file, index) => {
              const fileItem = createFileItem(file, index);
              container.appendChild(fileItem);
          });
      }
      
      function createFileItem(file, index) {
          const item = document.createElement('div');
          item.className = 'file-item';
          
          const icon = document.createElement('div');
          icon.className = 'file-icon';
          
          if (file.type.startsWith('image/')) {
              icon.classList.add('image');
              icon.textContent = 'ðŸ–¼ï¸';
          } else if (file.type.startsWith('video/')) {
              icon.classList.add('video');
              icon.textContent = 'ðŸŽ¥';
          } else if (file.type.startsWith('audio/')) {
              icon.classList.add('audio');
              icon.textContent = 'ðŸŽµ';
          } else {
              icon.classList.add('document');
              icon.textContent = 'ðŸ“„';
          }
          
          const details = document.createElement('div');
          details.className = 'file-details';
          
          const name = document.createElement('div');
          name.className = 'file-name';
          name.textContent = file.name;
          
          const size = document.createElement('div');
          size.className = 'file-size';
          size.textContent = formatFileSize(file.size);
          
          details.appendChild(name);
          details.appendChild(size);
          
          const removeBtn = document.createElement('button');
          removeBtn.className = 'remove-file';
          removeBtn.textContent = 'Ã—';
          removeBtn.type = 'button';
          removeBtn.addEventListener('click', () => {
              selectedFiles.splice(index, 1);
              updateFilesList();
          });
          
          item.appendChild(icon);
          item.appendChild(details);
          item.appendChild(removeBtn);
          
          return item;
      }
      
      function formatFileSize(bytes) {
          if (bytes === 0) return '0 Bytes';
          const k = 1024;
          const sizes = ['Bytes', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }
      
      // Form submission
      document.getElementById('massMessageForm').addEventListener('submit', function(e) {
          e.preventDefault();
          
          const selectedGroups = document.querySelectorAll('input[name="group_ids"]:checked');
          const messageText = document.getElementById('messageText').value.trim();
          const sendButton = document.getElementById('sendButton');
          const loading = document.getElementById('loading');
          const status = document.getElementById('status');
          const progressBar = document.getElementById('progressBar');
          const progressFill = document.getElementById('progressFill');
          
          // Validation
          if (selectedGroups.length === 0) {
              showStatus('error', 'Kamida bitta guruhni tanlang!');
              return;
          }
          
          if (!messageText && selectedFiles.length === 0) {
              showStatus('error', 'Matn yoki fayl kiriting!');
              return;
          }
          
          // Prepare form data
          const formData = new FormData();
          formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
          
          if (messageText) {
              formData.append('message_text', messageText);
          }
          
          selectedGroups.forEach(checkbox => {
              formData.append('group_ids', checkbox.value);
          });
          
          selectedFiles.forEach(file => {
              formData.append('files', file);
          });
          
          // UI updates
          sendButton.disabled = true;
          loading.style.display = 'block';
          progressBar.style.display = 'block';
          status.style.display = 'none';
          
          let progress = 0;
          const progressInterval = setInterval(() => {
              progress += 2;
              if (progress <= 90) {
                  progressFill.style.width = progress + '%';
              }
          }, 100);
          
          // Send request
          fetch('/send-mass-message/', {
              method: 'POST',
              body: formData
          })
          .then(response => response.json())
          .then(data => {
              clearInterval(progressInterval);
              progressFill.style.width = '100%';
              
              if (data.success) {
                  let message = `âœ… Muvaffaqiyat! ${data.successful_sends} ta guruhga yuborildi.`;
                  if (data.failed_sends > 0) {
                      message += ` âŒ ${data.failed_sends} ta xatolik.`;
                      if (data.errors && data.errors.length > 0) {
                          message += '\n\nXatoliklar:\n' + data.errors.join('\n');
                      }
                  }
                  showStatus('success', message);
                  
                  // Clear form on success
                  document.getElementById('messageText').value = '';
                  selectedFiles = [];
                  updateFilesList();
                  document.querySelectorAll('input[name="group_ids"]').forEach(cb => cb.checked = false);
                  document.getElementById('selectAll').checked = false;
              } else {
                  showStatus('error', `âŒ Xatolik: ${data.error}`);
              }
          })
          .catch(error => {
              clearInterval(progressInterval);
              showStatus('error', `âŒ Xatolik yuz berdi: ${error.message}`);
          })
          .finally(() => {
              sendButton.disabled = false;
              loading.style.display = 'none';
              setTimeout(() => {
                  progressBar.style.display = 'none';
                  progressFill.style.width = '0%';
              }, 1000);
          });
      });
      
      function showStatus(type, message) {
          const status = document.getElementById('status');
          status.className = 'status ' + type;
          status.innerHTML = message.replace(/\n/g, '<br>');
          status.style.display = 'block';
          
          // Auto hide after 10 seconds for success, 15 for error
          const hideTime = type === 'success' ? 10000 : 15000;
          setTimeout(() => {
              status.style.display = 'none';
          }, hideTime);
      }
  </script>

{% endblock %}