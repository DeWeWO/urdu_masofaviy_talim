{% extends  'base.html' %}
{% load static %}

{% block title %} Tasdiqlash {% endblock title %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'plugins/datatables-bs4/css/dataTables.bootstrap4.min.css' %}">
  <link rel="stylesheet" href="{% static 'plugins/datatables-responsive/css/responsive.bootstrap4.min.css' %}">
  <link rel="stylesheet" href="{% static 'plugins/datatables-buttons/css/buttons.bootstrap4.min.css' %}">
  <link rel="stylesheet" href="{% static 'dist/css/adminlte.min.css' %}">
  <style>
  .card-header {
      background-color: #f4f4f4;
      border-bottom: 1px solid #ddd;
  }

  .table-hover tbody tr:hover {
      background-color: #f5f5f5;
  }

  #messageResult {
      border-radius: 5px;
  }

  .spinner-border {
      width: 3rem;
      height: 3rem;
  }

  .form-check-input:checked {
      background-color: #007bff;
      border-color: #007bff;
  }
  </style>
{% endblock %}


{% block content %}

  {% include 'base/navbar.html' %}

  {% include 'base/aside.html' with table_active=True group_active=True %}

  {% include 'base/content_table.html' %}

  {% include 'base/footer.html' %}

  {% include 'base/down_aside.html' %}

{% endblock content %}


{% block extra_js %}
  <script src="{% static 'plugins/datatables/jquery.dataTables.min.js' %}"></script>
  <script src="{% static 'plugins/datatables-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
  <script src="{% static 'plugins/datatables-responsive/js/dataTables.responsive.min.js' %}"></script>
  <script src="{% static 'plugins/datatables-responsive/js/responsive.bootstrap4.min.js' %}"></script>
  <script src="{% static 'plugins/datatables-buttons/js/dataTables.buttons.min.js' %}"></script>
  <script src="{% static 'plugins/datatables-buttons/js/buttons.bootstrap4.min.js' %}"></script>
  <script src="{% static 'plugins/jszip/jszip.min.js' %}"></script>
  <script src="{% static 'plugins/pdfmake/pdfmake.min.js' %}"></script>
  <script src="{% static 'plugins/pdfmake/vfs_fonts.js' %}"></script>
  <script src="{% static 'plugins/datatables-buttons/js/buttons.html5.min.js' %}"></script>
  <script src="{% static 'plugins/datatables-buttons/js/buttons.print.min.js' %}"></script>
  <script src="{% static 'plugins/datatables-buttons/js/buttons.colVis.min.js' %}"></script>



<!-- Excel, PDF va CSV uchun kutubxonalar -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>



<!-- JavaScript for send message -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const messageForm = document.getElementById('messageForm');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const messageResult = document.getElementById('messageResult');
    const resultContent = document.getElementById('resultContent');

    // --- CHECKBOXLAR (student/teacher) bir vaqtning o'zida faollashmasligi uchun ---
    document.querySelectorAll('.student-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                const rowId = this.value;
                const teacherCheckbox = document.getElementById(`teacher_${rowId}`);
                if (teacherCheckbox) teacherCheckbox.checked = false;
            }
        });
    });

    document.querySelectorAll('.teacher-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                const rowId = this.value;
                const studentCheckbox = document.getElementById(`student_${rowId}`);
                if (studentCheckbox) studentCheckbox.checked = false;
            }
        });
    });

    // --- Xabar yuborish formasi ---
    if (messageForm) {
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(messageForm);
            const target = formData.get('target');
            const method = formData.get('method');
            const message = formData.get('message');

            // Validation
            if (!target || !method || !message.trim()) {
                alert('‚ö†Ô∏è Barcha maydonlarni to‚Äòldiring!');
                return;
            }

            // Ogohlantirish (faqat guruh uchun)
            if (method === 'group' && !confirm('üì¢ Guruh chatiga xabar yuboriladi. Davom etasizmi?')) {
                return;
            }

            // Loaderni ko‚Äòrsatish
            loadingSpinner.style.display = 'block';
            messageResult.style.display = 'none';

            // AJAX orqali yuborish
            fetch('/send-message/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(async response => {
                const data = await response.json();
                loadingSpinner.style.display = 'none';

                if (!response.ok || data.error) {
                    resultContent.innerHTML = `
                        <div class="text-danger">
                            <strong>‚ùå Xatolik:</strong> ${data.error || 'Server xatosi yuz berdi'}
                        </div>
                    `;
                } else {
                    let resultHtml = `
                        <div class="text-success">
                            <strong>‚úÖ Muvaffaqiyatli yuborildi:</strong> ${data.sent} ta<br>
                            <strong>‚ùå Muvaffaqiyatsiz:</strong> ${data.failed} ta<br>
                            <strong>üìä Jami:</strong> ${data.total} ta<br>
                            <strong>üîÑ Usul:</strong> ${data.method}
                        </div>
                    `;
                    
                    if (data.errors && data.errors.length > 0) {
                        resultHtml += `
                            <div class="text-warning mt-2">
                                <strong>‚ö†Ô∏è Ayrim xatolar:</strong><br>
                                <ul class="mb-0">
                                    ${data.errors.map(error => `<li>${error}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    resultContent.innerHTML = resultHtml;
                }

                messageResult.style.display = 'block';
                messageForm.reset(); // Formani tozalash
            })
            .catch(error => {
                loadingSpinner.style.display = 'none';
                resultContent.innerHTML = `
                    <div class="text-danger">
                        <strong>‚ùå Xatolik:</strong> ${error.message}
                    </div>
                `;
                messageResult.style.display = 'block';
            });
        });
    }
});
</script>



<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.student-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                const registerId = this.id.split('_')[1];
                document.querySelector(`#teacher_${registerId}`).checked = false;
            }
        });
    });
    
    document.querySelectorAll('.teacher-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                const registerId = this.id.split('_')[1];
                document.querySelector(`#student_${registerId}`).checked = false;
            }
        });
    });
});
</script>


<script>
$(function () {
  // Jadval 1 (asosiy)
  $('#example1').DataTable({
    paging: false,
    lengthChange: false,
    searching: true,
    ordering: true,
    info: false,
    autoWidth: false,
    responsive: true,
    scrollY: '290px',
    scrollX: true,
    scrollCollapse: true,
    dom: '<"d-flex justify-content-start mb-2"f>rt'
  });

  // Jadval 2 va 3
  $('#example2, #example3').DataTable({
    paging: false,
    lengthChange: false,
    searching: true,
    ordering: true,
    info: false,
    autoWidth: false,
    responsive: true,
    scrollY: '240px',
    scrollX: true,
    scrollCollapse: true,
    dom: '<"d-flex justify-content-start mb-2"f>rt'
  });

  // === Export funksiyalari ===

  // Excel (har jadval alohida sheet)
  $('#export-excel').on('click', function () {
    var wb = XLSX.utils.book_new();

    var ws1 = XLSX.utils.table_to_sheet(document.getElementById('example1'));
    XLSX.utils.book_append_sheet(wb, ws1, "Jadval 1");

    var ws2 = XLSX.utils.table_to_sheet(document.getElementById('example2'));
    XLSX.utils.book_append_sheet(wb, ws2, "Jadval 2");

    var ws3 = XLSX.utils.table_to_sheet(document.getElementById('example3'));
    XLSX.utils.book_append_sheet(wb, ws3, "Jadval 3");

    XLSX.writeFile(wb, "barcha_jadvallar.xlsx");
  });

  // PDF (har jadval alohida sahifa)
  $('#export-pdf').on('click', function () {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Jadval 1
    doc.text("Jadval 1", 14, 15);
    doc.autoTable({ html: '#example1', startY: 20 });

    // Jadval 2
    doc.addPage();
    doc.text("Jadval 2", 14, 15);
    doc.autoTable({ html: '#example2', startY: 20 });

    // Jadval 3
    doc.addPage();
    doc.text("Jadval 3", 14, 15);
    doc.autoTable({ html: '#example3', startY: 20 });

    doc.save("barcha_jadvallar.pdf");
  });

  // CSV (uchala jadval ketma-ket yoziladi)
  $('#export-csv').on('click', function () {
    function tableToCSV(tableId) {
      let csv = [];
      let rows = document.querySelectorAll(`#${tableId} tr`);
      rows.forEach(row => {
        let cols = row.querySelectorAll('td, th');
        let rowData = [];
        cols.forEach(col => rowData.push('"' + col.innerText.replace(/"/g, '""') + '"'));
        csv.push(rowData.join(","));
      });
      return csv.join("\n");
    }

    let csvContent = "Jadval 1\n" + tableToCSV("example1") +
                     "\n\n--- Jadval 2 ---\n" + tableToCSV("example2") +
                     "\n\n--- Jadval 3 ---\n" + tableToCSV("example3");

    let blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    let link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "barcha_jadvallar.csv";
    link.click();
  });
});
</script>


{% endblock %}